name: Run Tests
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      # 1. Получение кода из репозитория
      - uses: actions/checkout@v4

      # 2. Очистка кэша Maven (ускоряет сборку)
      - name: Clean Maven cache
        run: mvn dependency:purge-local-repository

      # 3. Кэширование Maven зависимостей (экономит время на следующих запусках)
      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository  # Стандартная директория Maven
          key: maven-${{ hashFiles('pom.xml') }}  # Ключ зависит от pom.xml
          restore-keys: |
            maven-  # Резервный ключ если точный не найден
      # 4. Кэширование браузеров Playwright (браузеры весят 100+ МБ)
      - name: Cache Playwright browsers
        uses: actions/cache@v3
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            playwright-${{ runner.os }}-
      # 5. Установка Java 17 (версия для запуска тестов)
      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin  # Дистрибутив OpenJDK
          java-version: '17'

      # 6. Сборка зависимостей проекта (без запуска тестов)
      - name: Resolve dependencies
        run: mvn install -DskipTests

      # 7. Установка браузера Chromium для Playwright
      - name: Install Playwright browsers
        run: mvn exec:java -Dexec.mainClass="com.microsoft.playwright.CLI" -Dexec.args="install chromium"

      # 8. Проверка тестовых файлов перед запуском (отладка)
      - name: Check test files
        run: |
          echo "=== Доступные тесты ==="
          find src/test -name "*Test.java" -type f | head -10
          echo "=== Структура проекта ==="
          ls -la
      # 9. ЗАПУСК ВСЕХ ТЕСТОВ с поддержкой Allure
      - name: Run all tests with Allure
        id: run_tests  # ID для получения результата позже
        run: |
          echo "Starting all tests in CI environment..."
          echo "CI detected: $CI"
          echo "GITHUB_ACTIONS: $GITHUB_ACTIONS"
          
          # Запускаем ВСЕ тесты проекта
          mvn clean test -Dheadless=true -B -DfailIfNoTests=false
          
          # Сохраняем код возврата для использования в следующих шагах
          TESTS_EXIT_CODE=$?
          echo "Tests completed with exit code: $TESTS_EXIT_CODE"
          echo "exit_code=$TESTS_EXIT_CODE" >> $GITHUB_OUTPUT
        env:
          CI: true  # Явно указываем CI окружение для Traceable интерфейса
          ALLURE_RESULTS_DIR: target/allure-results  # Директория для Allure
          TRACE_ONLY_FAILED: true  # Флаг для сохранения только упавших тестов

      # 10. Проверка созданных файлов (отладка при проблемах)
      - name: Check generated files
        if: always()  # Выполнять даже если тесты упали
        run: |
          echo "=== Проверка результатов тестов ==="
          echo "Surefire reports:"
          find target/surefire-reports -name "*.txt" -type f 2>/dev/null | head -5 || echo "No surefire reports"
          
          echo "=== Проверка трейсов ==="
          echo "All traces directory:"
          ls -la target/traces-all/ 2>/dev/null || echo "No traces-all directory"
          
          echo "Failed-only traces directory:"
          ls -la target/traces-failed-only/ 2>/dev/null || echo "No traces-failed-only directory"
          
          echo "=== Проверка Allure результатов ==="
          ls -la target/allure-results/ 2>/dev/null || echo "No allure results"
          
          echo "=== Поиск всех ZIP файлов (трейсы) ==="
          find target -name "*.zip" -type f 2>/dev/null | head -10 || echo "No zip files found"
      # 12. Установка Allure CLI для генерации отчетов
      - name: Install Allure CLI
        if: always()  # Устанавливать всегда
        run: |
          echo "Installing Allure CLI..."
          sudo wget -q -O /tmp/allure.tgz https://github.com/allure-framework/allure2/releases/download/2.24.0/allure-2.24.0.tgz
          sudo tar -xzf /tmp/allure.tgz -C /opt/
          sudo ln -sf /opt/allure-2.24.0/bin/allure /usr/local/bin/allure
          allure --version
      # 13. Генерация красивого HTML отчета Allure
      - name: Generate Allure Report
        if: always()
        run: |
          echo "Generating Allure report..."
          allure generate target/allure-results -o allure-report --clean
          echo "Allure report generated"
          du -sh allure-report/
      # 14. Загрузка Allure отчета как артефакта
      - name: Upload Allure Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: allure-report/

      # 15. Загрузка трейсов ТОЛЬКО для упавших тестов (основной артефакт)
      - name: Upload failed test traces
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-traces-failed
          path: target/traces-failed-only/
          if-no-files-found: ignore  # Не вызывать ошибку если папка пустая

      # 16. Загрузка ВСЕХ трейсов (для отладки и локального тестирования)
      - name: Upload all traces (debug)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-traces-all
          path: target/traces-all/
          if-no-files-found: ignore

      # 17. Загрузка сырых результатов тестов (JUnit формата)
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: target/surefire-reports/

      # 18. Очистка старых трейсов чтобы не копить мусор
      - name: Clean old traces
        if: always()
        run: |
          echo "Cleaning trace directories..."
          # Удаляем трейсы старше 7 дней (опционально)
          find target/traces-failed-only -name "*.zip" -mtime +7 -delete 2>/dev/null || true
          find target/traces-all -name "*.zip" -mtime +7 -delete 2>/dev/null || true
          echo "Cleanup completed"
      # 19. Итоговая информация о выполнении тестов
      - name: Test summary
        if: always()
        run: |
          echo "=== TEST EXECUTION SUMMARY ==="
          echo "Test exit code: ${{ steps.run_tests.outputs.exit_code }}"
          echo "Workflow result: ${{ job.status }}"
          
          # Подсчет упавших тестов
          FAILED_TESTS=$(find target/surefire-reports -name "*.txt" -exec grep -l "FAILURE\|ERROR" {} \; 2>/dev/null | wc -l || echo "0")
          echo "Failed tests: $FAILED_TESTS"
          
          # Информация о сохраненных трейсах
          FAILED_TRACES=$(find target/traces-failed-only -name "*.zip" -type f 2>/dev/null | wc -l || echo "0")
          echo "Traces saved for failed tests: $FAILED_TRACES"
          
          # Предупреждение если трейсы не создались при падении тестов
          if [ "$FAILED_TESTS" -gt 0 ] && [ "$FAILED_TRACES" -eq 0 ]; then
            echo "WARNING: Tests failed but no traces were saved!"
            echo "Check Traceable implementation in your test classes."
          fi
          
          echo "=== Артефакты доступны для скачивания ==="
          echo "1. allure-report - HTML отчет Allure"
          echo "2. pdf-report - PDF отчет (только при успехе)"
          echo "3. playwright-traces-failed - трейсы упавших тестов"
          echo "4. playwright-traces-all - все трейсы (отладка)"
          echo "5. test-results - сырые результаты тестов"

