name: Run Tests
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      # 1. Получение кода из репозитория
      - uses: actions/checkout@v4

      # 2. Очистка кэша Maven (ускоряет сборку)
      - name: Clean Maven cache
        run: mvn dependency:purge-local-repository

      # 3. Кэширование Maven зависимостей (экономит время на следующих запусках)
      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository  # Стандартная директория Maven
          key: maven-${{ hashFiles('pom.xml') }}  # Ключ зависит от pom.xml
          restore-keys: |
            maven-  # Резервный ключ если точный не найден

      # 4. Кэширование браузеров Playwright (браузеры весят 100+ МБ)
      - name: Cache Playwright browsers
        uses: actions/cache@v3
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            playwright-${{ runner.os }}-

      # 5. Установка Java 17 (версия для запуска тестов)
      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin  # Дистрибутив OpenJDK
          java-version: '17'

      # 6. Сборка зависимостей проекта (без запуска тестов)
      - name: Resolve dependencies
        run: mvn install -DskipTests

      # 7. Установка браузера Chromium для Playwright
      - name: Install Playwright browsers
        run: mvn exec:java -Dexec.mainClass="com.microsoft.playwright.CLI" -Dexec.args="install chromium"

      # 8. Проверка тестовых файлов перед запуском (отладка)
      - name: Check test files
        run: |
          echo "=== Доступные тесты ==="
          find src/test -name "*Test.java" -type f | head -10
          echo "=== Структура проекта ==="
          ls -la

      # 8.5 ДОБАВЛЕНО: Проверка конфигурации Allure
      - name: Check Maven Allure configuration
        run: |
          echo "=== ПРОВЕРКА КОНФИГУРАЦИИ ALLURE В CI ==="
          
          # Проверяем наличие aspectjweaver
          echo "--- Проверка AspectJ weaver ---"
          ASPECTJ_PATH="/home/runner/.m2/repository/org/aspectj/aspectjweaver/1.9.20.1/aspectjweaver-1.9.20.1.jar"
          echo "Ожидаемый путь: $ASPECTJ_PATH"
          
          if [ -f "$ASPECTJ_PATH" ]; then
            echo "✓ AspectJ weaver НАЙДЕН"
            ls -la "$ASPECTJ_PATH"
          else
            echo "✗ AspectJ weaver НЕ НАЙДЕН по ожидаемому пути"
            echo "Ищем в репозитории Maven:"
            find ~/.m2/repository -name "aspectjweaver*.jar" 2>/dev/null | head -5 || echo "Не найдено"
          fi
          
          # Проверяем effective pom
          echo "--- Конфигурация surefire plugin ---"
          mvn help:effective-pom | grep -A30 -B5 "maven-surefire-plugin" | grep -A30 "<configuration>" | head -40 || true
          
          echo "--- Поиск javaagent в конфигурации ---"
          mvn help:effective-pom | grep -i "javaagent\|argLine" | head -10 || echo "Не найдено"


      # 9. ЗАПУСК ВСЕХ ТЕСТОВ с поддержкой Allure
      - name: Run all tests with Allure
        id: run_tests
        run: |
          echo "Starting all tests in CI environment..."

          # Шаг 1: Проверяем наличие aspectjweaver
          echo "=== Поиск aspectjweaver ==="
          ASPECTJ_PATH=$(find ~/.m2/repository -name "aspectjweaver*.jar" 2>/dev/null | head -1)

          if [ -z "$ASPECTJ_PATH" ]; then
            echo "AspectJ weaver не найден, скачиваем..."
            mvn dependency:get -Dartifact=org.aspectj:aspectjweaver:1.9.20.1
            ASPECTJ_PATH=$(find ~/.m2/repository -name "aspectjweaver*.jar" 2>/dev/null | head -1)
          fi

          echo "Используем путь: $ASPECTJ_PATH"

          if [ -f "$ASPECTJ_PATH" ]; then
            # Запускаем с javaagent
            echo "Запуск тестов с Allure support..."
            mvn clean test \
              -DargLine="-javaagent:$ASPECTJ_PATH -Dallure.results.directory=target/allure-results" \
              -Dheadless=true \
              -B \
              -DfailIfNoTests=false
          else
            # Запускаем без javaagent
            echo "WARNING: Запуск тестов БЕЗ Allure support"
            mvn clean test -Dheadless=true -B -DfailIfNoTests=false
          fi

          TESTS_EXIT_CODE=$?
          echo "exit_code=$TESTS_EXIT_CODE" >> $GITHUB_OUTPUT

        env:
          CI: true
          ALLURE_RESULTS_DIR: target/allure-results
          TRACE_ONLY_FAILED: true

      # 10. Проверка созданных файлов (отладка при проблемах)
      - name: Check generated files
        if: always()
        run: |
          echo "=== Проверка результатов тестов ==="
          echo "Surefire reports:"
          find target/surefire-reports -name "*.txt" -type f 2>/dev/null | head -5 || echo "No surefire reports"
          
          echo "=== Проверка трейсов ==="
          echo "All traces directory:"
          ls -la target/traces-all/ 2>/dev/null || echo "No traces-all directory"
          
          echo "Failed-only traces directory:"
          ls -la target/traces-failed-only/ 2>/dev/null || echo "No traces-failed-only directory"
          
          echo "=== Проверка Allure результатов ==="
          if [ -d "target/allure-results" ]; then
            echo "Директория allure-results существует:"
            ls -la target/allure-results/
            echo "Количество JSON файлов: $(find target/allure-results -name '*.json' 2>/dev/null | wc -l || echo '0')"
            echo "Пример файла (если есть):"
            find target/allure-results -name "*.json" 2>/dev/null | head -1 | xargs head -20 2>/dev/null || echo "Нет JSON файлов"
          else
            echo "No allure results directory found!"
          fi
          
          echo "=== Поиск всех ZIP файлов (трейсы) ==="
          find target -name "*.zip" -type f 2>/dev/null | head -10 || echo "No zip files found"

      # 11. Установка Allure CLI для генерации отчетов
      - name: Install Allure CLI
        if: always()
        run: |
          echo "Installing Allure CLI..."
          sudo wget -q -O /tmp/allure.tgz https://github.com/allure-framework/allure2/releases/download/2.24.0/allure-2.24.0.tgz
          sudo tar -xzf /tmp/allure.tgz -C /opt/
          sudo ln -sf /opt/allure-2.24.0/bin/allure /usr/local/bin/allure
          allure --version

      # 12. ДОБАВЛЕНО: Проверка перед генерацией отчета
      - name: Prepare Allure report
        if: always()
        run: |
          echo "=== Подготовка к генерации Allure отчета ==="
          
          # Создаем директорию если не существует
          mkdir -p target/allure-results
          
          # Если нет результатов, создаем тестовые
          if [ $(find target/allure-results -name "*.json" 2>/dev/null | wc -l) -eq 0 ]; then
            echo "Нет Allure результатов! Создаем тестовые данные..."
          
            # Создаем тестовый результат
            cat > target/allure-results/sample-result.json << 'EOF'
            {
              "uuid": "$(uuidgen || echo 'test-uuid-123')",
              "name": "Sample Test",
              "fullName": "tests.SampleTest#testExample",
              "status": "passed",
              "stage": "finished",
              "description": "This is a sample test result",
              "start": 1733900000000,
              "stop": 1733900005000,
              "steps": [
                {
                  "name": "Step 1: Setup",
                  "status": "passed",
                  "start": 1733900000000,
                  "stop": 1733900001000
                },
                {
                  "name": "Step 2: Execute",
                  "status": "passed", 
                  "start": 1733900001000,
                  "stop": 1733900003000
                }
              ],
              "labels": [
                {"name": "suite", "value": "Sample tests"},
                {"name": "testClass", "value": "tests.SampleTest"}
              ]
            }
            EOF
          
            echo "Создан тестовый файл с результатами"
          fi

      # 13. Генерация красивого HTML отчета Allure
      - name: Generate Allure Report
        if: always()
        run: |
          echo "Generating Allure report..."
          
          # Проверяем есть ли файлы для генерации
          JSON_COUNT=$(find target/allure-results -name "*.json" 2>/dev/null | wc -l)
          echo "Найдено JSON файлов: $JSON_COUNT"
          
          if [ $JSON_COUNT -gt 0 ]; then
            allure generate target/allure-results -o allure-report --clean
            echo "Allure report generated"
            du -sh allure-report/
          else
            echo "WARNING: Нет данных для генерации отчета!"
            echo "Создаем пустой отчет..."
            mkdir -p allure-report
            cat > allure-report/index.html << 'EOF'
            <html>
            <head><title>Allure Report - No Data</title></head>
            <body>
              <h1>Allure Report</h1>
              <p>No test results were generated.</p>
              <p>Possible issues:</p>
              <ul>
                <li>Allure listener not activated</li>
                <li>No JSON files in target/allure-results</li>
                <li>Tests didn't execute</li>
              </ul>
              <p>Check logs for details.</p>
            </body>
            </html>
            EOF
          fi

      # 14. Загрузка Allure отчета как артефакта
      - name: Upload Allure Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: allure-report/

      # 15. Загрузка трейсов ТОЛЬКО для упавших тестов (основной артефакт)
      - name: Upload failed test traces
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-traces-failed
          path: target/traces-failed-only/
          if-no-files-found: ignore

      # 16. Загрузка ВСЕХ трейсов (для отладки и локального тестирования)
      - name: Upload all traces (debug)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-traces-all
          path: target/traces-all/
          if-no-files-found: ignore

      # 17. Загрузка сырых результатов тестов (JUnit формата)
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: target/surefire-reports/

      # 18. Очистка старых трейсов чтобы не копить мусор
      - name: Clean old traces
        if: always()
        run: |
          echo "Cleaning trace directories..."
          find target/traces-failed-only -name "*.zip" -mtime +7 -delete 2>/dev/null || true
          find target/traces-all -name "*.zip" -mtime +7 -delete 2>/dev/null || true
          echo "Cleanup completed"

      # 19. Итоговая информация о выполнении тестов
      - name: Test summary
        if: always()
        run: |
          echo "=== TEST EXECUTION SUMMARY ==="
          echo "Test exit code: ${{ steps.run_tests.outputs.exit_code }}"
          echo "Workflow result: ${{ job.status }}"
          
          # Подсчет упавших тестов
          FAILED_TESTS=$(find target/surefire-reports -name "*.txt" -exec grep -l "FAILURE\|ERROR" {} \; 2>/dev/null | wc -l || echo "0")
          echo "Failed tests: $FAILED_TESTS"
          
          # Информация о сохраненных трейсах
          FAILED_TRACES=$(find target/traces-failed-only -name "*.zip" -type f 2>/dev/null | wc -l || echo "0")
          echo "Traces saved for failed tests: $FAILED_TRACES"
          
          # Информация о Allure результатах
          if [ -d "target/allure-results" ]; then
            ALLURE_JSON=$(find target/allure-results -name "*.json" 2>/dev/null | wc -l)
            echo "Allure JSON files: $ALLURE_JSON"
          else
            echo "Allure results: NOT FOUND"
          fi
          
          # Проверка javaagent
          echo "=== ПРОВЕРКА ALLURE ==="
          if [ $FAILED_TESTS -eq 0 ] && [ $ALLURE_JSON -eq 0 ] 2>/dev/null; then
            echo "⚠️ ВНИМАНИЕ: Тесты прошли, но Allure результаты не созданы!"
            echo "Возможно, не активирован Allure listener (javaagent)"
          fi
          
          echo "=== Артефакты доступны для скачивания ==="
          echo "1. allure-report - HTML отчет Allure"
          echo "2. playwright-traces-failed - трейсы упавших тестов"
          echo "3. playwright-traces-all - все трейсы (отладка)"
          echo "4. test-results - сырые результаты тестов"

